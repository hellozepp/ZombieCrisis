# ZombieCrisis 代码索引

## 📁 项目结构

```
ZombieCrisis/
├── src/
│   └── Game/
│       ├── Main.java              # 程序入口
│       ├── Start.java             # 开始界面
│       ├── GameClient.java        # 游戏客户端主窗口
│       ├── World.java             # 游戏世界管理器
│       ├── WorldGrids.java        # 网格系统（寻路用）
│       ├── Direction.java         # 方向枚举
│       ├── GameObject.java        # 游戏对象基类
│       ├── Role.java              # 角色基类
│       ├── Hero.java              # 英雄（玩家）
│       ├── Enemy.java             # 敌人基类
│       ├── Monster.java           # 怪物（近战敌人）
│       ├── Ghost.java             # 幽灵（远程敌人）
│       ├── Weapon.java            # 武器基类
│       ├── Sword.java             # 剑（近战武器）
│       ├── Hand.java              # 拳头（敌人近战武器）
│       ├── Ball.java              # 弹丸基类
│       ├── Fireball.java          # 火球（玩家远程武器）
│       ├── Ghostball.java         # 幽灵弹（敌人远程武器）
│       ├── Wall.java              # 墙壁
│       ├── Border.java            # 边界
│       ├── Box.java               # 宝箱
│       ├── Blood.java             # 血迹效果
│       ├── Pathfinder.java        # 寻路算法（A*）
│       └── PathNode.java          # 寻路节点
└── images/                        # 图片资源目录
    ├── hero.png                   # 英雄精灵图
    ├── monster.png                # 怪物精灵图
    ├── ghost.png                  # 幽灵精灵图
    ├── fireball.png               # 火球精灵图
    ├── ghostball.png              # 幽灵弹精灵图
    ├── wall.png                   # 墙壁图片
    ├── box.png                    # 宝箱图片
    ├── blood.png                  # 血迹图片
    ├── gameover.png               # 游戏结束图片
    ├── single.jpg                 # 单人模式按钮
    └── double.jpg                 # 双人模式按钮
```

---

## 📚 类索引

### 1. 核心系统类

#### **Main.java**
- **功能**: 程序入口
- **主要方法**: 
  - `main()` - 启动游戏

#### **Start.java**
- **功能**: 游戏开始界面
- **继承**: `JFrame`
- **主要组件**:
  - `SinglePlayerListener` - 单人模式监听器
  - `DoublePlayerListener` - 双人模式监听器
- **主要方法**:
  - `Start()` - 构造界面，创建按钮

#### **GameClient.java**
- **功能**: 游戏主窗口和游戏循环
- **继承**: `Frame`
- **主要组件**:
  - `PaintThread` - 绘制线程（游戏主循环）
  - `KeyMonitor` - 键盘监听器
- **主要方法**:
  - `lauchFrame()` - 启动游戏窗口
  - `paint(Graphics g)` - 绘制游戏画面
  - `update(Graphics g)` - 双缓冲更新

#### **World.java**
- **功能**: 游戏世界管理器
- **主要属性**:
  - `objects` - 游戏对象列表（线程安全）
  - `bloods` - 血迹列表
  - `maxEnemyNum` - 当前波次最大敌人数
  - `currentEnemyNum` - 当前存活敌人数
- **主要方法**:
  - `produceEnemy()` - 生成敌人
  - `produceBox()` - 生成宝箱
  - `collisionDetection()` - 碰撞检测
  - `drawWorld()` - 绘制世界
  - `gameOver()` - 游戏结束

#### **WorldGrids.java**
- **功能**: 网格系统（用于敌人寻路）
- **主要组件**:
  - `Grid` - 网格类（内部类）
- **主要方法**:
  - `updateGrids()` - 更新网格状态
  - `getGrid()` - 获取指定位置的网格
  - `nextMoves()` - 获取可移动的相邻网格

---

### 2. 游戏对象类

#### **GameObject.java** (抽象基类)
- **功能**: 所有游戏对象的基类
- **主要属性**:
  - `x, y` - 坐标
  - `radius` - 半径（碰撞检测用）
  - `speed` - 速度
  - `HP` - 生命值
  - `dir` - 方向
  - `collidable` - 是否可碰撞
- **抽象方法**:
  - `draw()` - 绘制
  - `collisionResponse()` - 碰撞响应
  - `onAttack()` - 受攻击
- **主要方法**:
  - `collisionDetection()` - 碰撞检测
  - `drawOneImage()` - 绘制精灵图帧

---

### 3. 角色类

#### **Role.java** (抽象类)
- **继承**: `GameObject`
- **功能**: 角色基类（玩家和敌人的共同父类）
- **主要属性**:
  - `weapons` - 武器列表
  - `currentWeapon` - 当前武器
  - `walkState` - 行走动画状态
  - `deadState` - 死亡状态计数器
  - `bloodBar` - 血条（内部类）
- **主要方法**:
  - `move()` - 移动
  - `drawWalkImage()` - 绘制行走动画
  - `onAttack()` - 受攻击处理
  - `NextWeapon()` - 切换武器

#### **Hero.java**
- **继承**: `Role`
- **功能**: 玩家角色
- **主要属性**:
  - `MAX_HP = 1200` - 最大生命值
  - `keys[]` - 键盘按键映射
  - `bL, bU, bR, bD` - 方向键状态
- **操作说明**:
  - **1P**: WASD移动 + J攻击 + K切换武器 + L大招
  - **2P**: 方向键移动 + 小键盘1攻击 + 2切换武器 + 3大招
- **主要方法**:
  - `KeyPressed()` - 按键按下处理
  - `keyReleased()` - 按键释放处理
  - `locateDirection()` - 确定移动方向

#### **Enemy.java** (抽象类)
- **继承**: `Role`
- **功能**: 敌人基类
- **主要属性**:
  - `pathfinder` - 寻路器（A*算法）
  - `target` - 目标玩家
  - `path` - 路径列表
- **主要方法**:
  - `getTarget()` - 寻找最近的玩家
  - `getPath()` - 计算路径
  - `locateDirection()` - 根据路径确定方向
  - `judgeAccurateDir()` - 精确判断朝向

#### **Monster.java**
- **继承**: `Enemy`
- **功能**: 近战怪物
- **属性**:
  - HP: 170
  - 速度: 2
  - 武器: Hand（拳头）
  - 伤害: 100
  - 攻击范围: 50

#### **Ghost.java**
- **继承**: `Enemy`
- **功能**: 远程幽灵
- **属性**:
  - HP: 130
  - 速度: 2
  - 武器: Ghostball（幽灵弹）
  - 攻击范围: 300

---

### 4. 武器类

#### **Weapon.java** (抽象类)
- **继承**: `GameObject`
- **功能**: 武器基类
- **主要属性**:
  - `host` - 持有者
  - `damage` - 伤害值
  - `coldDownTime` - 冷却时间
  - `coldDown` - 当前冷却计数
  - `attackRange` - 攻击范围
  - `attackAngle` - 攻击角度
- **主要方法**:
  - `Attack()` - 执行攻击
  - `drawNomalAttack()` - 绘制攻击动画
  - `maintainColdDown()` - 维护冷却

#### **Sword.java**
- **继承**: `Weapon`
- **功能**: 剑（玩家近战武器）
- **属性**:
  - 伤害: 80
  - 冷却: 12帧
  - 攻击范围: 80
  - 攻击角度: 42度

#### **Hand.java**
- **继承**: `Weapon`
- **功能**: 拳头（敌人近战武器）
- **属性**:
  - 伤害: 60
  - 冷却: 12帧
  - 攻击范围: 55
  - 攻击角度: 70度

#### **Ball.java** (抽象类)
- **继承**: `Weapon`
- **功能**: 弹丸基类
- **主要属性**:
  - `num` - 弹药数量
  - `ultimateState` - 大招状态
- **主要方法**:
  - `initFireball()` - 初始化弹丸
  - `setUltimateState()` - 释放大招（8方向发射）

#### **Fireball.java**
- **继承**: `Ball`
- **功能**: 火球（玩家远程武器）
- **属性**:
  - 伤害: 55
  - 速度: 15
  - 冷却: 10帧
  - 最大弹药: 80

#### **Ghostball.java**
- **继承**: `Ball`
- **功能**: 幽灵弹（敌人远程武器）
- **属性**:
  - 伤害: 80
  - 速度: 8
  - 冷却: 30帧
  - 弹药: 无限

---

### 5. 环境对象类

#### **Wall.java**
- **继承**: `GameObject`
- **功能**: 墙壁障碍物
- **属性**: 不可破坏，阻挡移动

#### **Border.java**
- **继承**: `GameObject`
- **功能**: 地图边界
- **属性**: 巨大的圆形碰撞体，限制活动范围

#### **Box.java**
- **继承**: `GameObject`
- **功能**: 宝箱（补给箱）
- **掉落内容**:
  - 45%概率: 补满火球弹药
  - 45%概率: 补满生命值
  - 10%概率: 无掉落
- **重生时间**: 800帧

#### **Blood.java**
- **继承**: `GameObject`
- **功能**: 血迹效果（装饰）
- **属性**: 不可碰撞，纯视觉效果

---

### 6. 寻路系统

#### **Pathfinder.java**
- **功能**: A*寻路算法实现
- **主要属性**:
  - `openNodes` - 开放列表
  - `closedNodes` - 关闭列表
  - `worldGrids` - 世界网格
- **主要方法**:
  - `shortestPath()` - 计算最短路径
  - `getHeuristic()` - 计算启发式值（曼哈顿距离）
  - `getCost()` - 计算移动代价
  - `nextMoves()` - 获取可移动的相邻格子

#### **PathNode.java**
- **功能**: 寻路节点
- **实现**: `Comparable<PathNode>`
- **主要属性**:
  - `g` - 起点到当前点的代价
  - `h` - 当前点到终点的启发式估计
  - `f` - 总代价 (f = g + h)
  - `depth` - 深度
  - `parentNode` - 父节点

---

### 7. 工具类

#### **Direction.java**
- **类型**: 枚举
- **功能**: 定义8个方向和停止状态
- **枚举值**: `L, R, U, D, LU, RU, LD, RD, STOP`
- **主要方法**:
  - `toDegree()` - 方向转角度
  - `getVectorX()` - 获取X分量
  - `getVectorY()` - 获取Y分量

---

## 🔗 类继承关系图

```
Object
│
├── JFrame
│   └── Start
│
├── Frame
│   └── GameClient
│
├── Enum
│   └── Direction
│
└── GameObject (抽象)
    ├── Role (抽象)
    │   ├── Hero
    │   └── Enemy (抽象)
    │       ├── Monster
    │       └── Ghost
    │
    ├── Weapon (抽象)
    │   ├── Sword
    │   ├── Hand
    │   └── Ball (抽象)
    │       ├── Fireball
    │       └── Ghostball
    │
    ├── Wall
    ├── Border
    ├── Box
    └── Blood
```

---

## 📊 关键数据结构

### 游戏对象列表 (World.objects)
- **类型**: `CopyOnWriteArrayList<GameObject>`
- **线程安全**: 是
- **包含**: 玩家、敌人、墙壁、边界、宝箱等所有游戏对象

### 网格系统 (WorldGrids.grids)
- **类型**: `List<Grid>`
- **网格大小**: 10x10像素
- **用途**: 敌人寻路、碰撞优化

### 武器列表 (Role.weapons)
- **类型**: `List<Weapon>`
- **用途**: 存储角色的所有武器，支持切换

---

## 🎮 游戏机制说明

### 1. 碰撞检测
- **算法**: 圆形碰撞检测
- **实现**: 计算两个对象中心点距离，与半径和比较
- **响应**: 碰撞时将对象推开，避免重叠

### 2. 敌人AI
- **寻路**: A*算法
- **目标选择**: 选择最近的存活玩家
- **路径刷新**: 每30帧重新计算路径
- **攻击判定**: 
  - Monster: 距离<50时近战攻击
  - Ghost: 距离<300且朝向角度<60度时发射弹丸

### 3. 波次系统
- **初始波次**: 3个敌人
- **递增规则**: 每波敌人全部消灭后，下一波+3个
- **生成位置**: 地图四个边界随机位置
- **敌人比例**: 10% Ghost, 90% Monster

### 4. 武器系统
- **切换**: K键（1P）或小键盘2（2P）
- **冷却**: 每个武器独立冷却
- **大招**: L键（1P）或小键盘3（2P），消耗8发火球，8方向发射

### 5. 补给系统
- **宝箱**: 拾取后800帧重生
- **掉落**: 45%火球弹药，45%生命值，10%无

---

## 🎨 渲染系统

### 双缓冲
- **实现**: `GameClient.update()`
- **原理**: 先在离屏图像绘制，再一次性显示
- **效果**: 避免画面闪烁

### 深度排序
- **实现**: `World.objectSort()`
- **规则**: 按Y坐标排序（Y小的先绘制）
- **效果**: 实现遮挡关系

### 精灵动画
- **实现**: `Role.drawWalkImage()`
- **帧数**: 每个方向4帧行走动画
- **切换**: 每4帧切换一次

---

## 📝 代码规范

### 命名规范
- **类名**: 大驼峰 (PascalCase)
- **方法名**: 小驼峰 (camelCase)
- **常量**: 全大写下划线 (UPPER_SNAKE_CASE)

### 包结构
- **包名**: `Game`
- **资源路径**: `/images/`

### 线程安全
- **游戏对象列表**: 使用 `CopyOnWriteArrayList`
- **绘制线程**: 独立线程，30ms刷新一次

---

## 🔧 扩展建议

### 添加新敌人
1. 继承 `Enemy` 类
2. 在构造方法中设置属性（HP、速度、武器）
3. 重写 `draw()` 方法实现特殊行为
4. 在 `World.produceEnemy()` 中添加生成逻辑

### 添加新武器
1. 继承 `Weapon` 或 `Ball` 类
2. 设置伤害、冷却、攻击范围等属性
3. 重写 `Attack()` 方法实现特殊效果
4. 在 `Hero` 构造方法中添加到武器列表

### 添加新道具
1. 继承 `GameObject` 类
2. 实现 `collisionResponse()` 处理拾取逻辑
3. 在 `World` 构造方法中添加到对象列表

---

**文档版本**: 1.0  
**最后更新**: 2026-02-22  
**作者**: ZombieCrisis开发团队
